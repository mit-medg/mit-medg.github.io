<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <title>MEDG Theses</title>

  <link href="https://fonts.googleapis.com/css?family=Crimson+Text:300italic,400italic|Roboto:300,400,300italic,400italic" rel="stylesheet">
  <style>
    :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#ffffff; }
    * { box-sizing: border-box; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family:'Source Sans Pro','Helvetica Neue',Helvetica,Arial,sans-serif; }

    /* Navigation */
    #header {
      position: sticky; top: 0; z-index: 50;
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(248,250,252,.92);
      backdrop-filter: saturate(180%) blur(6px);
      border-bottom: 1px solid #e2e8f0; padding: 12px 18px;
    }
    #header h1, #header h1 a {
      margin:0; font-family:'Roboto','Helvetica Neue',Helvetica,Arial,sans-serif;
      font-weight:300; text-transform:uppercase; letter-spacing:normal; /* normal spacing */
      font-size:1.1em; color:navy; text-decoration:none;
    }
    #nav ul { list-style:none; display:flex; gap:22px; margin:0; padding:0; flex-wrap:wrap; }
    #nav a {
      display:inline-block; padding:6px 8px; border:none;
      color:#8a8f98; text-decoration:none;
      font-family:'Roboto','Helvetica Neue',Helvetica,Arial,sans-serif;
      font-weight:300; text-transform:uppercase; letter-spacing:normal; /* normal spacing */
      font-size:1em; background:transparent;
    }
    #nav a:hover { color:#2e2e2e; }

    main { max-width: 1000px; margin: 24px auto; padding: 0 18px 48px; }
    .wrap { max-width: 1000px; margin: 0 auto 6px; padding: 0 18px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:16px;
      box-shadow:0 2px 10px rgba(2,6,23,.06); padding:18px; }

    /* Filters: single row, compact */
    .filters{
      display:flex;
      flex-wrap:nowrap;
      gap:8px;
      align-items:flex-end;
      overflow-x:auto;
      padding-bottom:2px;
    }
    .filters .field{
      flex:0 0 auto;
      min-width:0;
      position:relative;
    }
    .filters label{
      display:block;
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:2px;
      white-space:nowrap;
    }
    .filters input{
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:8px 28px 8px 10px;
      font-size:.95rem;
      width:160px; /* compact */
    }
    .filters select{
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:8px 28px 8px 10px;
      font-size:.95rem;
      width:auto; /* shrink to widest option text */
      max-width:none;
      white-space:nowrap;
    }
    #f-title{ width:220px; }

    /* Clear button */
    .clear-btn{
      position:absolute;
      right:8px;
      top:50%;
      transform:translateY(-50%);
      cursor:pointer;
      font-weight:700;
      color:red;
      font-size:1rem;
      display:none;
      user-select:none;
    }
    .field input:not(:placeholder-shown)+.clear-btn{ display:block; }

    /* List + compact spacing */
    #output { counter-reset:item; list-style:none; padding-left:0; }
    #output li {
      counter-increment:item; background:#fff; border:1px solid #e2e8f0; border-radius:10px;
      padding:4px 6px; margin:2px 0;
    }
    #output li::before {
  content: counter(item) ". ";
  font-weight: 400;   /* or 'normal' */
  margin-right: 6px;
}
    #output li.group {
      counter-increment:none; background:transparent; border:none; padding:0; margin:10px 0 2px;
      font-weight:700; font-size:1.05rem;
    }
    #output li.group::before { content:''; margin:0; }

    .small{font-size:.9rem}
    .error{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:6px 10px;border-radius:8px;margin-top:8px}

    /* [bib] toggle and inline BibTeX display */
    .bib-btn {
      margin-left:6px;
      padding:0 6px;
      font:inherit;
      font-size:.85em;
      color:#444;
      background:transparent;
      border:1px solid #cbd5e1;
      border-radius:6px;
      cursor:pointer;
    }
    .bib-btn:hover { background:#f1f5f9; }
    .bib-block {
      white-space:pre-wrap;
      background:#f8fafc;
      border:1px solid #e2e8f0;
      border-radius:8px;
      padding:8px;
      margin-top:6px;
      font-size:.85rem;
    }
  </style>
</head>
<body>
  <header id="header">
    <h1><strong><a href="index.html">MIT CSAIL MEDG</a></strong></h1>
    <nav id="nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="people.html">People</a></li>
        <li><a href="https://www.csail.mit.edu/research/clinical-decision-making-group#projects" target="_blank">Projects</a></li>
        <li><a href="publications.html">Publications</a></li>
        <li><a href="theses.html">Theses</a></li>
        <li><a href="blogs.html">Blogs</a></li>
        <li><a href="seminars.html">Seminars</a></li>
        <li><a href="faq.html">FAQs</a></li>
        <li><a href="https://groups.csail.mit.edu/medg/index_archive.html" target="_blank">Archive</a></li>
      </ul>
    </nav>
  </header>

  <main>

    <div class="card">
      <div id="filters" class="filters">
        <div class="field">
          <label for="f-ttype">Thesis type</label>
          <select id="f-ttype">
            <option value="">All</option>
            <option value="doctoral">Doctoral</option>
            <option value="masters">Master's</option>
            <option value="bachelors">Bachelor's</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="field">
          <label for="f-name">Name</label>
          <input id="f-name" type="text" placeholder="e.g., Patil"/>
          <span class="clear-btn" data-target="f-name">☒</span>
        </div>
        <div class="field">
          <label for="f-title">Title</label>
          <input id="f-title" type="text" placeholder="e.g., learning"/>
          <span class="clear-btn" data-target="f-title">☒</span>
        </div>
        <div class="field">
          <label for="f-sup">Supervisor</label>
          <input id="f-sup" type="text" placeholder="e.g., Szolovits"/>
          <span class="clear-btn" data-target="f-sup">☒</span>
        </div>
        <div class="field">
          <label for="f-rdr">Reader</label>
          <input id="f-rdr" type="text" placeholder="e.g., Kohane"/>
          <span class="clear-btn" data-target="f-rdr">☒</span>
        </div>
      </div>
      <div id="status" class="small muted" style="margin-top:10px"></div>
      <div id="err" class="error" style="display:none"></div>
    </div>

    <ol id="output"></ol>
  </main>

  <script>
    /* ----- Elements & utilities ----- */
    var statusEl=document.getElementById('status'),
        errorEl=document.getElementById('err'),
        outputEl=document.getElementById('output'),
        filtersEl=document.getElementById('filters');

    var inType = function(){return document.getElementById('f-ttype');};
    var inName = function(){return document.getElementById('f-name');};
    var inTitle= function(){return document.getElementById('f-title');};
    var inSup  = function(){return document.getElementById('f-sup');};
    var inRdr  = function(){return document.getElementById('f-rdr');};

    function status(h){ if(statusEl) statusEl.innerHTML = h; }
    function showError(e){
      if(!errorEl) return;
      errorEl.style.display='block';
      var m=(e&&e.message)?e.message:String(e);
      errorEl.innerHTML = '⚠️ ' + escapeHtml(m) +
        '<div class="small">Tip: If this page is opened via <code>file:///</code>, browsers block <code>fetch</code>. Serve locally (e.g., <code>python3 -m http.server</code>).</div>';
      console.error(e);
    }

    /* [bib] lookup map */
    var entryByKey = new Map();

    /* ----- Which bib files to load ----- */
    var bibFiles = [ "bib/MEDG_theses.bib" ]; /* correct filename */

    /* ----- URL filters (optional) ----- */
    function getFilters(){
      try{
        var p=new URLSearchParams(window.location.search);
        var g=function(v){return v&&v.trim()?v.trim():'';};
        return {
          ttype:g(p.get('ttype')), name:g(p.get('name')), title:g(p.get('title')),
          supervisor:g(p.get('supervisor')), reader:g(p.get('reader'))
        };
      }catch(_){
        return { ttype:'', name:'', title:'', supervisor:'', reader:'' };
      }
    }

    var allEntries=[], currentEntries=[], filtersInitialized=false,
        initialUrlFilters={ttype:'', name:'', title:'', supervisor:'', reader:''};

    window.addEventListener('DOMContentLoaded', function(){
      initialUrlFilters=getFilters();
      setupLiveFilters();
      loadAll().catch(showError);
      // clear buttons
      var clears=document.querySelectorAll('.clear-btn');
      for(var i=0;i<clears.length;i++){
        clears[i].addEventListener('click', (function(btn){
          return function(){
            var id=btn.getAttribute('data-target');
            var inp=document.getElementById(id);
            if(inp){
              inp.value='';
              inp.dispatchEvent(new Event('input',{bubbles:true}));
              inp.dispatchEvent(new Event('change',{bubbles:true}));
            }
          };
        })(clears[i]));
      }
    });

    /* ----- Load & parse ----- */
    async function loadAll(){
      status('Fetching bib files…');
      if(errorEl) errorEl.style.display='none';
      var entries=[], failed=[];

      for(var i=0;i<bibFiles.length;i++){
        var f=bibFiles[i];
        try{
          var res=await fetch(f,{cache:'no-store'});
          if(!res.ok) throw new Error('HTTP ' + res.status);
          var txt=await res.text();
          var parsed=parseBibtex(txt);
          for(var j=0;j<parsed.length;j++){ parsed[j]._file=f; }
          entries=entries.concat(parsed);
        }catch(e){
          failed.push({file:f,error:e.message||String(e)});
        }
      }

      // Keep only thesis types
      entries = entries.filter(function(e){ return /^(phdthesis|mastersthesis|thesis)$/i.test(e.type); });

      // Deduplicate by key
      var map=new Map();
      for(var k=0;k<entries.length;k++){
        var e=entries[k];
        var kk=String(e.key||'').toLowerCase();
        if(!kk) continue;
        if(!map.has(kk)) map.set(kk,e);
      }
      entries = Array.from(map.values());

      // Build lookup for [bib]
      entryByKey = new Map(entries.map(function(e){ return [String(e.key||'').toLowerCase(), e]; }));

      allEntries = entries;
      var live = currentFilterValues();
      var filtered = applyFilters(entries, live);
      currentEntries = filtered;

      var msg = '<strong>' + filtered.length + '</strong> theses shown';
      if (failed.length) {
        var parts = failed.map(function(f){ return escapeHtml(f.file) + ' (' + escapeHtml(f.error) + ')'; }).join('; ');
        msg += '<div class="small" style="color:#991b1b">Failed: ' + parts + '</div>';
      }
      status(msg);

      renderTheses(filtered);
    }

    function currentFilterValues(){
      return {
        ttype: inType() && inType().value ? inType().value.trim() : (initialUrlFilters.ttype || ''),
        name:  inName() && inName().value ? inName().value.trim() : (initialUrlFilters.name || ''),
        title: inTitle() && inTitle().value ? inTitle().value.trim() : (initialUrlFilters.title || ''),
        supervisor: inSup() && inSup().value ? inSup().value.trim() : (initialUrlFilters.supervisor || ''),
        reader:     inRdr() && inRdr().value ? inRdr().value.trim() : (initialUrlFilters.reader || '')
      };
    }

    /* ----- Live filters ----- */
    function setupLiveFilters(){
      if(!filtersEl) return;
      var fT=inType();  if(fT)    fT.value    = initialUrlFilters.ttype      || '';
      var fN=inName();  if(fN)    fN.value    = initialUrlFilters.name       || '';
      var fTi=inTitle();if(fTi)   fTi.value   = initialUrlFilters.title      || '';
      var fS=inSup();   if(fS)    fS.value    = initialUrlFilters.supervisor || '';
      var fR=inRdr();   if(fR)    fR.value    = initialUrlFilters.reader     || '';

      if(!filtersInitialized){
        var handler=function(){
          var live = currentFilterValues();
          var filtered = applyFilters(allEntries, live);
          currentEntries = filtered;
          var msg = '<strong>' + filtered.length + '</strong> theses shown';
          if(live.ttype)      msg += ' — type: <code>' + escapeHtml(live.ttype) + '</code>';
          if(live.name)       msg += ' — name: <code>' + escapeHtml(live.name) + '</code>';
          if(live.title)      msg += ' — title: <code>' + escapeHtml(live.title) + '</code>';
          if(live.supervisor) msg += ' — supervisor: <code>' + escapeHtml(live.supervisor) + '</code>';
          if(live.reader)     msg += ' — reader: <code>' + escapeHtml(live.reader) + '</code>';
          status(msg);
          renderTheses(filtered);
        };
        ['input','keyup','change'].forEach(function(evt){ filtersEl.addEventListener(evt, handler); });
        requestAnimationFrame(handler);
        filtersInitialized=true;
      }
    }

    function applyFilters(entries,opts){
      opts = opts || {};
      var ttype=(opts.ttype||'').toLowerCase();
      var n=(opts.name||'').toLowerCase();
      var t=(opts.title||'').toLowerCase();
      var s=(opts.supervisor||'').toLowerCase();
      var r=(opts.reader||'').toLowerCase();

      return entries.filter(function(e){
        var nameStr=(renderNamesForFilter(e,true)||'').toLowerCase(); // full for theses
        var titleStr=((e.fields&&e.fields.title)?e.fields.title:'').replace(/[{}]/g,'').toLowerCase();
        var supStr=(renderSupervisorsForFilter(e)||'').toLowerCase();
        var rdrStr=(renderReadersForFilter(e)||'').toLowerCase();
        var typeOk=matchThesisCategory(e,ttype);
        return (!ttype || typeOk)
          && (n ? nameStr.indexOf(n)!==-1 : true)
          && (t ? titleStr.indexOf(t)!==-1 : true)
          && (s ? supStr.indexOf(s)!==-1 : true)
          && (r ? rdrStr.indexOf(r)!==-1 : true);
      });
    }

    function matchThesisCategory(entry,cat){
      if(!cat) return true;
      var f=entry.fields||{};
      var raw=(f.type||'').toString();
      var s=unlatex(raw.replace(/[{}]/g,'')).trim().toLowerCase();
      var hasAny=function(){
        for(var i=0;i<arguments.length;i++){
          if(s.indexOf(arguments[i])!==-1) return true;
        }
        return false;
      };
      if(cat==='doctoral') return hasAny('phd','ph.d','doctor','m.d','md','doctor of') || /phdthesis/i.test(entry.type);
      if(cat==='masters')  return hasAny('s.m','sm','m.s','ms','m.eng','meng','master');
      if(cat==='bachelors')return hasAny('bachelor','undergraduate','advanced undergraduate project','aup');
      return s && !(/phd|ph\.d|doctor|m\.?d|s\.?m|m\.?s|m\.?eng|master|bachelor|undergraduate|aup/.test(s));
    }

    /* ----- Rendering: Exploring → In progress → Year desc → Unknown ----- */
    function renderTheses(entries){
      var exploring=[], inProg=[], dated=[], unknown=[];
      for(var i=0;i<entries.length;i++){
        var e=entries[i];
        var g=groupRank(e);
        if(g===0){ exploring.push(e); continue; }
        if(g===1){ inProg.push(e); continue; }
        var y=parseInt(e.fields && e.fields.year ? e.fields.year : '0',10) || 0;
        if(y>0) dated.push(e); else unknown.push(e);
      }

      var tb=function(a,b){
        var ak=firstAuthorKey(a).localeCompare(firstAuthorKey(b));
        if(ak!==0) return ak;
        var t=(a.fields.title||'').localeCompare(b.fields.title||'');
        if(t!==0) return t;
        return (a.key||'').localeCompare(b.key||'');
      };
      exploring.sort(tb);
      inProg.sort(tb);
      dated.sort(function(a,b){
        var d=dateScore(b)-dateScore(a);
        if(d!==0) return d;
        return tb(a,b);
      });

      var byYear=new Map();
      for(var j=0;j<dated.length;j++){
        var yy=String(parseInt(dated[j].fields.year||'0',10));
        if(!byYear.has(yy)) byYear.set(yy,[]);
        byYear.get(yy).push(dated[j]);
      }
      var years=Array.from(byYear.keys()).map(function(n){return parseInt(n,10);})
        .filter(function(n){return !Number.isNaN(n)&&n>0;})
        .sort(function(a,b){return b-a;});

      outputEl.innerHTML='';
      var addHeader=function(label){
        var h=document.createElement('li'); h.className='group'; h.textContent=label; outputEl.appendChild(h);
      };
      var addItem=function(e){
        var li=document.createElement('li'); li.innerHTML=formatVancouverThesis(e); outputEl.appendChild(li);
      };

      if(exploring.length){ addHeader('Exploring'); for(var i1=0;i1<exploring.length;i1++) addItem(exploring[i1]); }
      if(inProg.length){ addHeader('In progress'); for(var i2=0;i2<inProg.length;i2++) addItem(inProg[i2]); }
      for(var yk=0; yk<years.length; yk++){
        var ylbl=String(years[yk]);
        addHeader(ylbl);
        var arr=byYear.get(ylbl)||[];
        for(var i3=0;i3<arr.length;i3++) addItem(arr[i3]);
      }
      if(unknown.length){
        addHeader('Unknown year');
        unknown.sort(tb);
        for(var i4=0;i4<unknown.length;i4++) addItem(unknown[i4]);
      }
      if(!exploring.length && !inProg.length && !years.length && !unknown.length){
        status('0 theses matched. Possible reasons: (1) MEDG_theses.bib failed to load, (2) no entries are thesis types, or (3) your filters hid them.');
      }
    }

    /* ----- Vancouver (theses variant) + helpers ----- */
    function formatVancouverThesis(entry){
      var f=entry.fields||{}; var strip=function(s){return (s||'').replace(/[{}]/g,'');};

      // Names (full, first-name first for theses)
      var people='';
      if(f.author && f.author.trim()){
        people = formatAuthors(strip(f.author), {abbr:false, full:true});
      }else if(f.editor && f.editor.trim()){
        var raw=strip(f.editor);
        var ed = formatAuthors(raw, {abbr:false, full:true}).replace(/[.]\s*$/,'');
        var cnt=(raw||'').split(/\s+and\s+/i).map(function(s){return s.trim();}).filter(Boolean).length;
        people = ed + (cnt>1 ? ' (editors).' : ' (editor).');
      }

      var rawTitle=(f.title||'').trim();
      var cleanTitle=unlatex(rawTitle.replace(/[{}]/g,''));
      var title=ensurePeriod(cleanTitle).trim();
      var doiClean=cleanDoi(f.doi||''); if(doiClean) f.doi=doiClean;
      var link=(f.url&&f.url.trim())?f.url.trim():(doiClean?('https://doi.org/'+doiClean):'');

      // School + Department
      var school=unlatex((f.school||f.institution||'').replace(/[{}]/g,'').trim());
      var dept  =unlatex((f.department||'').replace(/[{}]/g,'').trim());

      var year=(f.year||'').trim();
      var line=''; if(people) line+=people+' ';
      if(title){
        line += link
          ? '<a href="' + escapeAttr(link) + '" target="_blank" rel="noopener noreferrer"><strong>' + escapeHtml(title) + '</strong></a> '
          : '<strong>' + escapeHtml(title) + '</strong> ';
      }

      var containerBits='';
      if(school) containerBits += '<em>' + escapeHtml(school) + '</em>';
      if(dept)   containerBits += (containerBits?', ':'') + escapeHtml(dept);
      if(containerBits) line += containerBits + ' ';

      if(year) line += year + '. ';

      // Thesis Type
      var t=(f.type&&f.type.trim())?f.type:(entry.type.toLowerCase()==='phdthesis'?'PhD Thesis':entry.type.toLowerCase()==='mastersthesis'?"Master's Thesis":'Thesis');
      line += ' ' + escapeHtml(unlatex(t)) + '.';

      // Supervisors / Readers (first-name first)
      var sup=f.supervisor?formatPersonListGivenFirst(strip(f.supervisor)):'';
      var rdr=f.reader?formatPersonListGivenFirst(strip(f.reader)):'';
      if(sup){
        var sn=(f.supervisor||'').split(/\s+and\s+/i).filter(Boolean).length;
        line += sn>1 ? ' Supervisors: ' + escapeHtml(unlatex(sup)) + '.' : ' Supervisor: ' + escapeHtml(unlatex(sup)) + '.';
      }
      if(rdr){
        var rn=(f.reader||'').split(/\s+and\s+/i).filter(Boolean).length;
        line += rn>1 ? ' Readers: ' + escapeHtml(unlatex(rdr)) + '.' : ' Reader: ' + escapeHtml(unlatex(rdr)) + '.';
      }

      // Append [bib] toggle
      if (entry.key) {
        line += ' <button class="bib-btn" data-key="' + String(entry.key).toLowerCase() + '">[bib]</button>';
      }

      return line.trim();
    }

    function renderNamesForFilter(entry,fullNames){
      var f=entry.fields||{}; var strip=function(s){return (s||'').replace(/[{}]/g,'');};
      if(f.author&&f.author.trim()) return formatAuthors(strip(f.author),{abbr:!fullNames, full:!!fullNames}).replace(/[.]\s*$/,'');
      if(f.editor&&f.editor.trim()) return formatAuthors(strip(f.editor),{abbr:!fullNames, full:!!fullNames}).replace(/[.]\s*$/,'');
      return '';
    }
    function renderSupervisorsForFilter(entry){
      var f=entry.fields||{}; var strip=function(s){return (s||'').replace(/[{}]/g,'');};
      if(!f.supervisor) return '';
      return formatPersonListGivenFirst(strip(f.supervisor));
    }
    function renderReadersForFilter(entry){
      var f=entry.fields||{}; var strip=function(s){return (s||'').replace(/[{}]/g,'');};
      if(!f.reader) return '';
      return formatPersonListGivenFirst(strip(f.reader));
    }

    function ensurePeriod(s){ s=(s||'').trim(); if(!s) return s; return /[.!?]\s*$/.test(s) ? s : (s + '.'); }

    function formatAuthors(field,opts){
      opts = opts || {};
      var abbr = (opts.abbr!==false); // default true
      var full = !!opts.full;
      if(!field) return '';
      var parts=field.split(/\s+and\s+/i).map(function(s){return s.trim();}).filter(Boolean);
      var names=parts.map(function(name){
        var clean=(name||'').replace(/[{}]/g,'').trim();
        if(clean.indexOf(',')!==-1){
          var pair=clean.split(','); var last=(pair[0]||'').trim(); var givenRaw=(pair[1]||'').trim();
          if(full) return (unlatex(givenRaw) + ' ' + unlatex(last)).replace(/\s+/g,' ').trim();
          var init=givenToInitials(givenRaw,abbr);
          return init ? (unlatex(last) + ' ' + init) : unlatex(last);
        }else{
          var bits=clean.split(/\s+/).filter(Boolean);
          if(bits.length===1) return unlatex(bits[0]);
          var last=bits.pop(); var given=bits.join(' ');
          if(full) return (unlatex(given) + ' ' + unlatex(last)).replace(/\s+/g,' ').trim();
          var init=givenToInitials(given,abbr);
          return init ? (unlatex(last) + ' ' + init) : unlatex(last);
        }
      });
      var list=names.join(', ');
      return list ? list + '.' : '';
    }

    function formatPersonListGivenFirst(field){
      var parts=(field||'').split(/\s+and\s+/i).map(function(s){return s.trim();}).filter(Boolean);
      return parts.map(formatPersonGivenFirst).join('; ');
    }
    function formatPersonGivenFirst(name){
      var clean=(name||'').replace(/[{}]/g,'');
      if(clean.indexOf(',')!==-1){
        var a=clean.split(','); var last=(a[0]||'').trim(); var given=(a[1]||'').trim();
        if(!given) return unlatex(clean.trim());
        return (unlatex(given) + ' ' + unlatex(last)).replace(/\s+/g,' ').trim();
      }
      return unlatex(clean.replace(/\s+/g,' ').trim());
    }

    function givenToInitials(given,abbr){
      if(!given) return '';
      var letters = given
        .replace(/\([^)]*\)/g,'')
        .replace(/\{[^}]*\}/g,'')
        .split(/[-\s]+/).filter(Boolean)
        .map(function(w){ return w[0] ? w[0].toUpperCase() : ''; })
        .join(abbr?'':' ');
      return letters;
    }

    function unlatex(s){ return String(s||'').replace(/\\&/g,'&'); } // \& → &
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function escapeAttr(s){ return String(s).replaceAll('"','&quot;'); }
    function cleanDoi(s){
      if(!s) return '';
      var x = String(s).trim();
      x = x.replace(/^doi:\s*/i,'');
      x = x.replace(/^https?:\/\/(dx\.)?doi\.org\//i,'');
      x = x.replace(/\s+/g,'');
      x = x.replace(/[<>]/g,'');
      x = x.replace(/\.$/,'');
      return x;
    }
    function firstAuthorKey(entry){
      var base=(entry.fields && entry.fields.author && entry.fields.author.trim()) ? entry.fields.author : (entry.fields.editor||'');
      var a=(base||'').split(/\s+and\s+/i)[0]||'';
      return a.replace(/[{}]/g,'').replace(/[^a-zA-Z,\s-]/g,'').toLowerCase();
    }
    function dateScore(e){
      var y=parseInt(e.fields && e.fields.year ? e.fields.year : '0',10) || 0;
      var m=e.fields && e.fields.month ? e.fields.month : '0';
      var mm={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
      m = (mm[String(m).slice(0,3).toLowerCase()] || parseInt(m,10) || 0);
      var d=parseInt(e.fields && e.fields.day ? e.fields.day : '0',10) || 0;
      return y*10000 + m*100 + d;
    }
    function groupRank(e){
      var isTh=/^(phdthesis|mastersthesis)$/i.test(e.type);
      if(!isTh) return 3;
      var f=e.fields||{};
      var s=[f.status,f.note,f.keywords,f.annote,f.howpublished,f.remark].filter(Boolean).join(' ').toLowerCase();
      if(/(^|\b)explor(ing|ation)\b/.test(s)) return 0;
      if(/\bin[-\s]*progress\b|\bongoing\b|\bwork\s*in\s*progress\b/.test(s)) return 1;
      var hasYear=!!parseInt(f.year||'0',10);
      if(!hasYear) return 1;
      return 2;
    }

    /* [bib] toggle handler (event delegation) */
    document.addEventListener('click', function(ev){
      var btn = ev.target && ev.target.closest ? ev.target.closest('.bib-btn') : null;
      if(!btn) return;
      var li = btn.closest('li');
      if(!li) return;

      var open = li.querySelector('.bib-block');
      if(open){ open.remove(); return; }

      var key = (btn.getAttribute('data-key') || '').toLowerCase();
      var entry = entryByKey.get(key);
      if(!entry) return;

      var pre = document.createElement('pre');
      pre.className = 'bib-block';
      pre.textContent = buildBibtex(entry);
      li.appendChild(pre);
    });

    function buildBibtex(entry){
      var type = (entry.type || 'misc');
      var key  = (entry.key  || 'key');
      var f    = entry.fields || {};

      // Exclude unwanted fields (case-insensitive)
      var skip = /^(file|date-added|date-modified|bdsk-url)/i;

      var fields = Object.keys(f)
        .filter(function(k){ return k && !skip.test(k); })
        .sort(function(a,b){ return a.localeCompare(b); });

      var lines = fields.map(function(k){
        var v = String(f[k] == null ? '' : f[k]).trim();
        return '  ' + k + ' = {' + v + '}';
      });

      return '@' + type + '{' + key + ',\n' + lines.join(',\n') + '\n}';
    }

    /* ----- BibTeX parsing ----- */
    function parseBibtex(text){
      text = text.replace(/^\s*%.*$/gm,''); // strip comment lines
      var out=[]; var rx=/@([a-zA-Z]+)\s*\{\s*([^,]+)\s*,([\s\S]*?)\}\s*(?=@|$)/g; var m;
      while((m=rx.exec(text))){
        var type=(m[1]||'').toLowerCase();
        var key=(m[2]||'').trim();
        var body=(m[3]||'');
        out.push({type:key?type:'',key:key,fields:parseFields(body)});
      }
      return out;
    }
    function parseFields(body){
      var out={}; var i=0, t='', depth=0, inQ=false; var parts=[];
      while(i<body.length){
        var c=body[i];
        if(c=='"' && body[i-1] !== "\\"){ inQ=!inQ; t+=c; i++; continue; }
        if(c=='{' && !inQ){ depth++; t+=c; i++; continue; }
        if(c=='}' && !inQ && depth>0){ depth--; t+=c; i++; continue; }
        if(c==',' && !inQ && depth===0){ parts.push(t); t=''; i++; continue; }
        t+=c; i++;
      }
      if(t.trim()) parts.push(t);
      for(var k=0;k<parts.length;k++){
        var p=parts[k];
        var kv=p.split(/\s*=\s*/);
        if(kv.length<2) continue;
        var kk=kv.shift().trim().toLowerCase();
        var vv=kv.join('=').trim();
        out[kk]=unbrace(unquote(vv)).replace(/\s+/g,' ').trim();
      }
      return out;
    }
    function unquote(s){ if((s.startsWith('"')&&s.endsWith('"'))||(s.startsWith("'")&&s.endsWith("'"))) return s.slice(1,-1); return s; }
    function unbrace(s){
      var changed=true;
      while(changed){
        changed=false;
        if(s.startsWith('{')&&s.endsWith('}')){
          var d=0,ok=true;
          for(var i=0;i<s.length;i++){ var c=s[i]; if(c=='{') d++; if(c=='}') d--; if(d===0&&i<s.length-1){ ok=false; break; } }
          if(ok){ s=s.slice(1,-1); changed=true; }
        }
      }
      return s;
    }
  </script>
</body>
</html>